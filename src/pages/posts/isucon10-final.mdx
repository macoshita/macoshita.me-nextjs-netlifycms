---
slug: isucon10-final
title: ISUCON 10 完全敗北してきた
date: 2020-10-03
author: macoshita
---
完敗だった :innocent:

## 何がまずかった？

自分の担当分について。

### node.js の cluster 実装

今回、CPU が 2 core, 2 core, 4 core となっていたので、cluster 実装しないと golang のようにスコアがでない状況だった。  
オンメモリキャッシュもしてなかったので、素直に src/bin で仮想ベンチと API をクラスター化したが、

1. API とベンチを同じサーバで動かすなら、コア数 / 2 で fork しなきゃならないし、別々のサーバで動かすならコア数分 fork しなきゃならない
2. コアを使い切っていると、TypeScript のビルドが固まる

という、とても微妙な状況だった。特に 1 は golang みたいに初めからマルチコアで動く言語だったら気にしなくていいところなので、

### WebPush の実装

マニュアルに WebPush を実装すれば、ある API で空配列を返して良いと書いてあったんだけど、この実装がとても辛かった。

まず、マニュアルに書いてある通りに一度ベンチを回して isucon1 でログインしても、Push通知を受け取るボタンがブラウザ上に出てこないという現象に悩まされた。  
しばらくマニュアルとにらめっこして、最終的に別サーバで試したら普通にブラウザ上に出てきて、だめだったサーバでも何度かベンチを回していたら突然出るようになった。これは結局最後まで原因が謎だった。

その後、無事サンプル実装は動かせて Push も受け取れて、大まかな実装も不慣れながらも 15:00 に大体完了したんだけど、そこから一切スコアがつかず、ずっと以下のエラーメッセージに悩まされていた。

```
webpush: 不正な Web Push メッセージの送信がありました (/push/...): illegal base64 data at input byte 27
```

原因は DB に突っ込む notification の型と WebPush のペイロードに突っ込む notification の型がぐちゃぐちゃになっていたことだった。DB の返す値に型が定義されてないなーまぁいっかーで進めてたのが非常にまずかった。



### VSCode Remote

予選でほとんど問題なかったので最初はこれでやろうとしたんだけど、最初の方で 2 回 SSH が使えなくなり、こりゃだめだと諦めた。  
これがかなりテンパってしまって、vim で書いたりローカルで書いたものを持ってったりと、慣れるのにかなり時間がかかった。次回は絶対ローカルで開発する。。

### 時間配分

講評がでないとわからないけど、上記の Push が無くても、もうちょいマシなスコアにすることはできたのかもしれなくて、どこかで諦める判断があっても良かった。1 時間ごとにアラームならして「一旦手を引きましょう」とかしてもいいのかもしれない。



ただ、今回勝つにはおそらく Push をやっつけるしか無かっただろうから、勝とうとしたって目線だと、ここは悩ましい。

### 

