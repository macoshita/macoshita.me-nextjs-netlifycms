---
slug: isucon10-qualifier
title: ISUCON 10 予選通過してきた
date: 2020-09-13
author: macoshita
---
ISUCON 10 に参加して、ISUCON 5 以来の予選突破を果たした。

チーム名は「へしこず」。ISUCON 5 からずっと同じ名前・同じチームメンバーで参加し続けている。

ここ数年はだいたい予選突破の 5 位くらい届かずな感じの位置につけていた。が、去年は最後までスコアが伸びず一か八かのお祈り実装で最終スコア 0 というやらかしをしてしまった。今回は、そこで反省したことが活きた感もある。

以下、自分が担当した部分を中心に書く。

## 言語

node.js を選択した。おそらく予選通過チームでは珍しい。

ISUCON 5 から 8 までは ruby で参加していて、去年は「ISUCON ではやたらと golang が強い」という周りの空気に流されて、とうとう golang で参加した。アプリケーション側の実装は毎年そこまで重くはないという判断もあった。

が、これは正直かなりのミスだった。いくらコードの実装が重くないと言ってもゼロではないし、何よりそのちょっとしたコードを書くときに実装を読んで何かに気付くということが激減していた。

今回は 9 の予選を WSL2 上で動かしてみて、node.js コードが typescript で書かれているのに気づき、かつ[クラスター対応](https://gist.github.com/thearegee/3eea038b9f0c5e94de73f3c3482fa732)を入れてやれば golang と大差ないスコアになるということに気づいたので、これで行こう！となった。

## はじまり: Deno?!?!

SSH 接続に少々苦労したけど、基本的にはレギュレーションに書かれていた方法で接続できた。

SSH Config を書けば VSCode SSH で接続できるようになるので、すんなり開発スタート。メンバーが github にコミットできるようにしてくれたので、バックアップを取りつつ基本はサーバ直書き。

ブラウザから見れるようにするところは、下記のようなコマンドにした。運営から案内されてるやつではつなげなかった。ngrok 使ったという random の投稿をみて「なるほど～」とおもった

```shell
ssh -N isucon-server -J isucon-bastion -L 8080:localhost:80
```

で、早速問題が。 **TypeScript じゃねーじゃん！ってか Deno?!?!** 

……たしかに、JavaScript は node.js, TypeScript は Deno とすれば、TypeScript でやりたくない人の希望にも添えるんだろうけど、マジかーとなった。  
で、Deno で勝てるとは到底思えない（マニュアルにも不具合があるって書いてあったし）ので、node.js 実装を TypeScript 化するアプローチをとった。

- app.js を app.ts にする
- tsc --init で tsconfig 作って target を esnext に
- VSCode の quickfix で型定義を全部インストール
- tsc -w を回しっぱにする

これで 15 分くらいロスしたけど、運営の実装のバグを見つけたりもできたので良かったと思う。

## 前半: ベンチを回せない戦い

前半は運営の問題でベンチを回せない時間が続いた（運営の皆様、お疲れさまでした。。

自分はひたすらコードを読んで怪しいところを決め打とうとしていた。で、見つけたのが **なぞって検索 API**。 lat, lon をそれぞれカラム保存していて、なぞった軌跡を全部含む正方形で最初に MySQL から select し、そのあと N+1 でポリゴンに各点が入っているかを MySQL に投げ直してる。 **どうみてもワンクエリで結果を返せる。** しかもインデックスも何も効いていない。  
「なぞって検索は目玉機能で、ユーザーはこの検索をトリガーにして椅子を購入したり資料請求したりするのだろう。とすれば、ここの改善は得点につながる」という何の根拠もない裏読みもカマし、ベンチが回せないまま、geometory カラムに変更・ワンクエリ化・SPATIAL INDEX設定までをやっておいた。  
random みてると、おそらくこれは効いていたんだと思う（ベンチ回す前にやっちゃったからわかってないけど）



## 終盤: スモスモスーモが脳内ループ










